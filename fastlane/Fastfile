default_platform(:ios)

PROJECT_ROOT = File.expand_path("..", __dir__)

platform :ios do
  # --- Atomic lanes (single responsibility) ---

  desc "Install SPM dependencies"
  lane :install do
    Dir.chdir(PROJECT_ROOT) do
      sh "mise x -- tuist install"
    end
  end

  desc "Generate Xcode project"
  lane :generate do
    Dir.chdir(PROJECT_ROOT) do
      sh "mise x -- tuist generate"
    end
  end

  desc "Run SwiftLint"
  lane :lint do
    Dir.chdir(PROJECT_ROOT) do
      sh "mise x -- swiftlint"
    end
  end

  desc "Run Periphery dead code detection"
  lane :detect_dead_code do
    Dir.chdir(PROJECT_ROOT) do
      sh "mise x -- periphery scan"
    end
  end

  desc "Execute unit tests"
  lane :execute_tests do
    Dir.chdir(PROJECT_ROOT) do
      device = ENV["TUIST_TEST_DEVICE"]
      os = ENV["TUIST_TEST_OS"]
      result_path = ENV["RESULT_BUNDLE_PATH"]
      cmd = "mise x -- tuist test"
      cmd += " --device '#{device}'" if device
      cmd += " --os '#{os}'" if os
      cmd += " --result-bundle-path '#{result_path}'" if result_path
      sh cmd
    end
  end

  desc "Clean Tuist cache and generated project"
  lane :clean do
    Dir.chdir(PROJECT_ROOT) do
      sh "mise x -- tuist clean plugins generatedAutomationProjects projectDescriptionHelpers manifests editProjects runs binaries selectiveTests dependencies"
      sh "rm -rf *.xcodeproj *.xcworkspace"
    end
  end

  # --- Composite lane ---

  desc "Full ci check (install + generate + execute_tests + detect_dead_code)"
  lane :ci do
    install
    generate
    execute_tests
    detect_dead_code
  end
end
