name: CI

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-15
    timeout-minutes: 30

    env:
      TUIST_TEST_DEVICE: iPhone 17 Pro
      TUIST_TEST_OS: "26.1"
      RESULT_BUNDLE_PATH: fastlane/test_output/Challenge.xcresult

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 26.1.1
        run: |
          sudo xcode-select -s /Applications/Xcode_26.1.1.app
          xcodebuild -version

      - name: Install mise tools
        uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: gems-${{ runner.os }}-${{ hashFiles('Gemfile') }}
          restore-keys: |
            gems-${{ runner.os }}-

      - name: Install Fastlane
        run: |
          bundle config set --local path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Cache Tuist and SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            Tuist/.build
            Derived/
          key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Package.resolved') }}
          restore-keys: |
            tuist-${{ runner.os }}-

      - name: Install SPM dependencies
        run: bundle exec fastlane install

      - name: Generate Xcode project
        run: bundle exec fastlane generate

      - name: Run tests
        run: bundle exec fastlane execute_tests

      - name: Collect snapshot failures
        if: failure()
        run: |
          mkdir -p /tmp/snapshot-failures
          find ~/Library/Developer/CoreSimulator/Devices \
            -path "*/tmp/*" -name "*.png" \
            -exec cp {} /tmp/snapshot-failures/ \; 2>/dev/null || true
          echo "Collected snapshot failure images:"
          ls -la /tmp/snapshot-failures/ || echo "No snapshot failures found"

      - name: Upload snapshot failures
        if: failure()
        id: upload-snapshots
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-failures
          path: /tmp/snapshot-failures
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload xcresult on failure
        if: failure()
        id: upload-xcresult
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: fastlane/test_output
          retention-days: 7

      - name: Comment PR with test failure artifact
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          XCRESULT_URL: ${{ steps.upload-xcresult.outputs.artifact-url }}
          SNAPSHOTS_URL: ${{ steps.upload-snapshots.outputs.artifact-url }}
        with:
          script: |
            const xcresultUrl = process.env.XCRESULT_URL || '';
            const snapshotsUrl = process.env.SNAPSHOTS_URL || '';
            core.info(`xcresult URL: "${xcresultUrl}"`);
            core.info(`snapshots URL: "${snapshotsUrl}"`);
            const lines = [
              '## Test Results',
              '',
              ':x: **Tests failed.**',
              '',
              `[:arrow_down: Download xcresult](${xcresultUrl})`,
            ];
            if (snapshotsUrl) {
              lines.push(`[:camera: Download snapshot failures](${snapshotsUrl})`);
            }
            lines.push(
              '',
              '_Open the `.xcresult` file in Xcode to inspect failures. Snapshot PNGs show what CI captured._'
            );
            const body = lines.join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Detect dead code
        id: periphery
        continue-on-error: true
        run: |
          set +e
          OUTPUT=$(bundle exec fastlane detect_dead_code 2>&1)
          echo "$OUTPUT"
          echo 'PERIPHERY_OUTPUT<<PERIPHERY_EOF' >> "$GITHUB_ENV"
          echo "$OUTPUT" >> "$GITHUB_ENV"
          echo 'PERIPHERY_EOF' >> "$GITHUB_ENV"

      - name: Comment PR with Periphery results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = process.env.PERIPHERY_OUTPUT || '';
            const marker = '<!-- periphery-report -->';

            // Parse diagnostic lines: path/File.swift:line:col: warning: message
            const diagnosticRegex = /^(.+?):(\d+):(\d+):\s+warning:\s+(.+)$/gm;
            const findings = [];
            let match;
            while ((match = diagnosticRegex.exec(output)) !== null) {
              findings.push({
                file: match[1],
                line: match[2],
                description: match[4]
              });
            }

            let body;
            if (findings.length === 0) {
              body = [
                marker,
                '## Periphery \u2014 Dead code detection',
                '',
                ':white_check_mark: No unused code detected.'
              ].join('\n');
            } else {
              const rows = findings.map(f => {
                const shortFile = f.file.replace(/^.*?(?=Features\/|Sources\/|Tests\/)/, '');
                return `| :warning: | \`${shortFile}\` | ${f.line} | ${f.description} |`;
              });

              body = [
                marker,
                '## Periphery \u2014 Dead code detection',
                '',
                `Found **${findings.length}** unused code occurrence(s):`,
                '',
                '| | File | Line | Description |',
                '|---|------|------|-------------|',
                ...rows,
                '',
                '<details><summary>Full output</summary>',
                '',
                '```',
                output.substring(output.lastIndexOf('periphery scan'), output.length).substring(0, 65000),
                '```',
                '',
                '</details>'
              ].join('\n');
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const existing = comments.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
