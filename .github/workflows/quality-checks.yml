name: Quality Checks

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  unit-and-snapshot-tests:
    name: Unit & Snapshot Tests
    runs-on: macos-15
    timeout-minutes: 30

    env:
      TUIST_TEST_DEVICE: iPhone 17 Pro
      TUIST_TEST_OS: "26.1"
      TUIST_TEST_DERIVED_DATA_PATH: derived_data
      RESULT_BUNDLE_PATH: test_output/UnitSnapshot.xcresult

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          device: ${{ env.TUIST_TEST_DEVICE }}

      - name: Run unit and snapshot tests
        timeout-minutes: 15
        run: |
          mise x -- tuist test "Challenge (Dev)" \
            --device "$TUIST_TEST_DEVICE" \
            --os "$TUIST_TEST_OS" \
            --result-bundle-path "$RESULT_BUNDLE_PATH"

      - name: Test report
        if: failure()
        uses: ./.github/actions/test-report
        with:
          title: Unit & Snapshot Test Results
          artifact-name: unit-snapshot-results
          result-bundle-path: ${{ env.RESULT_BUNDLE_PATH }}

      - name: Detect dead code
        id: periphery
        continue-on-error: true
        run: |
          set +e
          INDEX_STORE="${TUIST_TEST_DERIVED_DATA_PATH}/Index.noindex/DataStore"
          if [ -d "$INDEX_STORE" ]; then
            echo "Reusing index store: $INDEX_STORE"
            OUTPUT=$(mise x -- periphery scan --skip-build --index-store-path "$INDEX_STORE" 2>&1)
          else
            echo "Index store not found, running full build"
            OUTPUT=$(mise x -- periphery scan 2>&1)
          fi
          echo "$OUTPUT"
          echo 'PERIPHERY_OUTPUT<<PERIPHERY_EOF' >> "$GITHUB_ENV"
          echo "$OUTPUT" >> "$GITHUB_ENV"
          echo 'PERIPHERY_EOF' >> "$GITHUB_ENV"

      - name: Periphery summary
        id: periphery-summary
        uses: actions/github-script@v7
        with:
          script: |
            const raw = process.env.PERIPHERY_OUTPUT || '';
            const output = raw.replace(/\x1b\[[0-9;]*m/g, '');

            const diagnosticRegex = /^(.+?):(\d+):(\d+):\s+warning:\s+(.+)$/gm;
            const findings = [];
            let match;
            while ((match = diagnosticRegex.exec(output)) !== null) {
              findings.push({
                file: match[1],
                line: match[2],
                description: match[4]
              });
            }

            let body;
            if (findings.length === 0) {
              body = [
                '## Periphery \u2014 Dead code detection',
                '',
                ':white_check_mark: No unused code detected.'
              ].join('\n');
            } else {
              const rows = findings.map(f => {
                const shortFile = f.file.replace(/^.*?(?=Features\/|Sources\/|Tests\/)/, '');
                return `| :warning: | \`${shortFile}\` | ${f.line} | ${f.description} |`;
              });

              body = [
                '## Periphery \u2014 Dead code detection',
                '',
                `Found **${findings.length}** unused code occurrence(s):`,
                '',
                '| | File | Line | Description |',
                '|---|------|------|-------------|',
                ...rows
              ].join('\n');
            }

            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, body + '\n');

            core.setOutput('body', body);

      - name: Comment PR with Periphery results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${{ steps.periphery-summary.outputs.body }}`
            });

  ui-tests:
    name: UI Tests
    runs-on: macos-15
    timeout-minutes: 30

    env:
      TUIST_TEST_DEVICE: iPhone 17 Pro
      TUIST_TEST_OS: "26.1"
      RESULT_BUNDLE_PATH: test_output/UITests.xcresult

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          device: ${{ env.TUIST_TEST_DEVICE }}

      - name: Run UI tests
        timeout-minutes: 25
        run: |
          mise x -- tuist test "ChallengeUITests" \
            --device "$TUIST_TEST_DEVICE" \
            --os "$TUIST_TEST_OS" \
            --result-bundle-path "$RESULT_BUNDLE_PATH"

      - name: Test report
        if: failure()
        uses: ./.github/actions/test-report
        with:
          title: UI Test Results
          artifact-name: ui-test-results
          result-bundle-path: ${{ env.RESULT_BUNDLE_PATH }}

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [unit-and-snapshot-tests, ui-tests]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check job results
        run: |
          echo "Unit & Snapshot Tests: ${{ needs.unit-and-snapshot-tests.result }}"
          echo "UI Tests: ${{ needs.ui-tests.result }}"
          if [ "${{ needs.unit-and-snapshot-tests.result }}" != "success" ] || [ "${{ needs.ui-tests.result }}" != "success" ]; then
            echo "::error::One or more jobs failed"
            exit 1
          fi
