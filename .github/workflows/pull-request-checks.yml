name: Pull Request Checks

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-15
    timeout-minutes: 30

    env:
      TUIST_TEST_DEVICE: iPhone 17 Pro
      TUIST_TEST_OS: "26.1"
      RESULT_BUNDLE_PATH: test_output/Challenge.xcresult

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 26.1.1
        run: |
          sudo xcode-select -s /Applications/Xcode_26.1.1.app
          xcodebuild -version

      - name: Install mise tools
        uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Cache Tuist and SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            Tuist/.build
            Derived/
          key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Package.resolved') }}
          restore-keys: |
            tuist-${{ runner.os }}-

      - name: Install SPM dependencies
        run: mise x -- tuist install

      - name: Generate Xcode project
        run: mise x -- tuist generate

      - name: Run tests
        run: |
          mise x -- tuist test \
            --device "$TUIST_TEST_DEVICE" \
            --os "$TUIST_TEST_OS" \
            --result-bundle-path "$RESULT_BUNDLE_PATH"

      - name: Extract test failures
        if: failure()
        run: |
          if [ -d "$RESULT_BUNDLE_PATH" ]; then
            python3 << 'PYEOF'
          import json, subprocess, os

          result = subprocess.run(
              ['xcrun', 'xcresulttool', 'get', 'test-results', 'tests',
               '--path', os.environ['RESULT_BUNDLE_PATH']],
              capture_output=True, text=True
          )
          if result.returncode != 0:
              exit(0)

          data = json.loads(result.stdout)
          failures = []

          def walk(node, parts):
              name = node.get('name', '')
              node_type = node.get('nodeType', '')
              if node_type == 'Test Plan':
                  for child in node.get('children', []):
                      walk(child, [])
                  return
              current = parts + [name] if name else parts
              if node.get('result') == 'Failed' and node_type == 'Test Case':
                  failures.append('/'.join(current))
              for child in node.get('children', []):
                  walk(child, current)

          for node in data.get('testNodes', []):
              walk(node, [])

          with open(os.environ['GITHUB_ENV'], 'a') as env:
              env.write('TEST_FAILURES<<TEST_FAILURES_EOF\n')
              env.write('\n'.join(failures))
              env.write('\nTEST_FAILURES_EOF\n')
          PYEOF
          fi

      - name: Upload xcresult on failure
        if: failure()
        id: upload-xcresult
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test_output
          retention-days: 7

      - name: Comment PR with test failures
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          XCRESULT_URL: ${{ steps.upload-xcresult.outputs.artifact-url }}
        with:
          script: |
            const xcresultUrl = process.env.XCRESULT_URL || '';
            const rawFailures = process.env.TEST_FAILURES || '';

            const lines = [
              '## Test Results',
              '',
              ':x: **Tests failed.**',
            ];

            if (rawFailures.trim()) {
              const failures = rawFailures.trim().split('\n');
              lines.push(
                '',
                '| | Test |',
                '|---|------|',
                ...failures.map(f => `| :x: | \`${f}\` |`)
              );
            }

            lines.push(
              '',
              `[:arrow_down: Download xcresult](${xcresultUrl})`,
              '',
              '_Open the `.xcresult` file in Xcode to inspect failures._'
            );

            const body = lines.join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Detect dead code
        id: periphery
        continue-on-error: true
        run: |
          set +e
          OUTPUT=$(mise x -- periphery scan 2>&1)
          echo "$OUTPUT"
          echo 'PERIPHERY_OUTPUT<<PERIPHERY_EOF' >> "$GITHUB_ENV"
          echo "$OUTPUT" >> "$GITHUB_ENV"
          echo 'PERIPHERY_EOF' >> "$GITHUB_ENV"

      - name: Comment PR with Periphery results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const raw = process.env.PERIPHERY_OUTPUT || '';
            const output = raw.replace(/\x1b\[[0-9;]*m/g, '');

            // Parse diagnostic lines: path/File.swift:line:col: warning: message
            const diagnosticRegex = /^(.+?):(\d+):(\d+):\s+warning:\s+(.+)$/gm;
            const findings = [];
            let match;
            while ((match = diagnosticRegex.exec(output)) !== null) {
              findings.push({
                file: match[1],
                line: match[2],
                description: match[4]
              });
            }

            let body;
            if (findings.length === 0) {
              body = [
                '## Periphery \u2014 Dead code detection',
                '',
                ':white_check_mark: No unused code detected.'
              ].join('\n');
            } else {
              const rows = findings.map(f => {
                const shortFile = f.file.replace(/^.*?(?=Features\/|Sources\/|Tests\/)/, '');
                return `| :warning: | \`${shortFile}\` | ${f.line} | ${f.description} |`;
              });

              body = [
                '## Periphery \u2014 Dead code detection',
                '',
                `Found **${findings.length}** unused code occurrence(s):`,
                '',
                '| | File | Line | Description |',
                '|---|------|------|-------------|',
                ...rows
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
